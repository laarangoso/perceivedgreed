#Title: "Consumer perceptions of organizational greed"

#AUTHORS NAMES

#In this script, we test normality, equality of variance assumptions and run a general linear model (ANCOVA)

#This code was created using R version 4.1 and it's likely to break if previous versions are used to run it



#Packages installation and loading
if(!require(rcompanion)){install.packages("rcompanion")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(sjPlot)){install.packages("sjPlot")}
if(!require(sjmisc)){install.packages("sjmisc")}
if(!require(car)){install.packages("car")}
if(!require(lsr)){install.packages("lsr")}
if(!require(ggpubr)){install.packages("ggpubr")}
if(!require(statix)){install.packages("rstatix")}
if(!require(tidyr)){install.packages("tidyr")}
if(!require(emmeans)){install.packages("emmeans")}
if(!require(broom)){install.packages("broom")}



library(rcompanion)
library(tidyverse)
library(sjPlot)
library(sjmisc)
library(data.table)
library(car)
library(lsr)
library(ggpubr)
library(rstatix)
library(tidyr)
library(emmeans)
library(broom)




#Data upload
mains_data <- read.csv("Study1_GScores.csv")


#1. Normality test

#a. Density plots for the different groups/cells - individual graphs
ggplot(mains_data, 
       aes(Score)) +
       ggtitle("Density Plots Greed Scores by Group") +
       theme(plot.title= element_text(hjust = 0.5)) +
       geom_density(fill="green", alpha =.3) + 
       labs (x= "Greed Score") + 
       geom_vline(xintercept = 5, color= "blue", linetype = "dashed") + 
       facet_grid(. ~ Group + Size)


# b. Density plots for the different groups - single graph
#Data frame introduce new variable
mains_data2<- transform(mains_data, 
                     GroupandSize= paste(Group, Size))

#Plot
ggplot(mains_data2, 
       aes(Score, fill= GroupandSize)) +
       ggtitle("Density Plot Scores by Group") +
       geom_density(alpha =.6) + 
       labs (x= "Greed Score") + 
       geom_vline(xintercept = 5, color= "blue", linetype = "dashed") + 
       theme_dark() + 
       theme(plot.title = element_text(hjust = 0.5)) 


#c. q plot - single graphs
qplot(sample = Score, 
      data= mains_data2, 
      shape=GroupandSize, 
      color= GroupandSize) + 
      labs(y= "Greed Score")

#Shapiro-Wilk test

#d. Summary stats per group
tapply(mains_data2$Score, 
       mains_data2$GroupandSize, 
       summary)

#e.Shapiro-Wilk tests by group
#Data frame transform, drop unneccesary variables, reorganize data
mains_data3 <- subset(mains_data2, 
                   select =c(Score, GroupandSize))
Dat <- data.table(mains_data3)

#Test
Dat[,
   .(W = shapiro.test(Score)$statistic, 
     P.value = shapiro.test(Score)$p.value),
   by = .(GroupandSize)]


#Assumption of normality for ANCOVA violated. We then rely on the central limit theorem.

#2. Correlation between covariates

#Load Data
anc_data <- read.csv("Combined Scores.csv")
head(anc_data)

# Correlations matrix
cor(anc_data[, c("Equality", "Need", "Equity", "Deprivation", "Blame")])


## Outliers. 

cutoff = qchisq(1-.001, ncol(anc_data[, 4:9]))
mahal = mahalanobis(anc_data[, 4:9],
                    colMeans(anc_data[, 4:9], na.rm = T),
                    cov(anc_data[, 4:9], use = "pairwise.complete.obs"))


cutoff
ncol(anc_data[, 4:9])
summary(mahal < cutoff)
noout = subset(anc_data, mahal<cutoff)

noout


#MODEL WITHOUT OUTLIERS
model_no <- lm(Greed ~ Size*Group + Equality + Need + Equity + Deprivation + Blame,
   data = noout)

summary.aov(model_no)

###

#3. Homoscedasicity test (Equality of variance)

# Fit the model
model <- lm(Greed ~ Size*Group + Equality + Need +
              Equity + Deprivation + Blame, data = noout)


# Inspect the model diagnostic metrics


#RESIDUALS, NORMALITY

model.metrics <- augment(model) %>%
  select(-.hat, -.sigma, -.fitted) # Remove details
head(model.metrics, 3)

shapiro_test(model.metrics$.resid)




leveneTest(Greed ~ Size*Group, 
           data = anc_data, 
           center=mean)

levene_test(.resid ~ Size*Group, data = model.metrics)


#4. Linearity of the relationship between DV and covariates per group  


?art

# a. Equality and Greed
ggscatter(
  anc_data, x = "Equality", y = "Greed",
  facet.by  = c("Size", "Group"), 
  short.panel.labs = FALSE
)+
  stat_smooth(method = "loess", span = 0.9)

# b. Need and Greed
ggscatter(
  anc_data, x = "Need", y = "Greed",
  facet.by  = c("Size", "Group"), 
  short.panel.labs = FALSE
)+
  stat_smooth(method = "loess", span = 0.9)

# c. Equity and Greed
ggscatter(
  anc_data, x = "Equity", y = "Greed",
  facet.by  = c("Size", "Group"), 
  short.panel.labs = FALSE
)+
  stat_smooth(method = "loess", span = 0.9)

# d. Deprivation and Greed
ggscatter(
  anc_data, x = "Deprivation", y = "Greed",
  facet.by  = c("Size", "Group"), 
  short.panel.labs = FALSE
)+
  stat_smooth(method = "loess", span = 0.9)

# e. Blame and Greed
ggscatter(
  anc_data, x = "Equality", y = "Greed",
  facet.by  = c("Size", "Group"), 
  short.panel.labs = FALSE
)+
  stat_smooth(method = "loess", span = 0.9)



# 5. Homogeneity of regression slopes

#a. Equality
anc_data %>%
  unite(col = "sizeandgroup", Size, Group) %>%
  anova_test(Greed ~ sizeandgroup*Equality)

#b. Need
anc_data %>%
  unite(col = "sizeandgroup", Size, Group) %>%
  anova_test(Greed ~ sizeandgroup*Need)

#c. Equity 
anc_data %>%
  unite(col = "sizeandgroup", Size, Group) %>%
  anova_test(Greed ~ sizeandgroup*Equity)

#Deprivation
anc_data %>%
  unite(col = "sizeandgroup", Size, Group) %>%
  anova_test(Greed ~ sizeandgroup*Deprivation)

#Blame
anc_data %>%
  unite(col = "sizeandgroup", Size, Group) %>%
  anova_test(Greed ~ sizeandgroup*Equality)



# 6. ANCOVA

# a. ANCOVA model: Factors: Size (Big vs Small) * Group (Small vs Big),
#Covariates: Equality, need, equity, deprivation and blame

output = lm(Greed ~ Size*Group + Equality + Need + Equity + Deprivation + Blame,
            data = anc_data)

# b. Summary
summary.aov(output)

 # c. etas
etaSquared(output)


#b. Interaction Plot


# Line plot

#a.
res.aov <- anc_data %>% 
  anova_test(Greed ~ Equality + Size*Group)
get_anova_table(res.aov)

# b
pwc <- anc_data %>% 
  group_by(Size) %>%
  emmeans_test(
    Greed ~ Group, covariate = Equality,
    p.adjust.method = "bonferroni"
  )


#c. 
lp <- ggline(
  get_emmeans(pwc), x = "Size", y = "emmean", 
  color = "Group", palette = "jco"
) +
  geom_errorbar(
    aes(ymin = conf.low, ymax = conf.high, color = Group), 
    width = 0.1
  )


# d.
pwc <- pwc %>% add_xy_position(x = "Size", fun = "mean_se", step.increase = 0.2)
pwc.filtered <- pwc %>% filter(Size == "Big")
lp + 
  stat_pvalue_manual(
    pwc.filtered, hide.ns = TRUE, tip.length = 0,
    bracket.size = 0
  ) +
  labs(
    subtitle = get_test_label(res.aov,  detailed = TRUE),
    caption = get_pwc_label(pwc)
  )




